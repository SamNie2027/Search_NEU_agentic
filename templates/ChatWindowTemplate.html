<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agentic Course Registration Assistant</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Flowbite -->
    <link href="https://cdn.jsdelivr.net/npm/flowbite@2.5.2/dist/flowbite.min.css" rel="stylesheet" />

    <!-- Google Fonts - Poppins and Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">

    <style>
        * {
            font-family: 'Inter', 'Poppins', sans-serif;
        }

        /* Animated gradient for heading */
        @keyframes gradient-shift {

            0%,
            100% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }
        }

        .gradient-text {
            background: linear-gradient(90deg, #dc2626, #ef4444, #dc2626, #991b1b);
            background-size: 300% 300%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: gradient-shift 3s ease infinite;
        }

        /* Red hover effects */
        .hover-red:hover {
            background-color: #dc2626;
            color: white;
            transform: translateY(-2px);
            transition: all 0.3s ease;
        }

        /* Chat message animations */
        .message-enter {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1f1f1f;
        }

        ::-webkit-scrollbar-thumb {
            background: #dc2626;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #991b1b;
        }
    </style>
</head>

<body class="bg-black text-white min-h-screen">
    <!-- Header -->
    <header class="bg-black border-b-2 border-red-600 sticky top-0 z-50 shadow-lg">
        <div class="container mx-auto px-4 py-3">
            <h1 class="text-2xl md:text-3xl font-bold text-center gradient-text mb-1">
                Agentic Course Registration Assistant
            </h1>
            <p class="text-center text-gray-300 text-sm md:text-base">
                Find your classes with the help of AI-powered search!
            </p>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Chat Messages Container -->
        <div id="chat-messages"
            class="mb-6 space-y-4 min-h-[400px] max-h-[600px] overflow-y-auto p-4 bg-gray-900 rounded-lg border border-gray-800 hidden">
            <!-- Incoming changes / messages area -->
            <div id="incoming-controls" class="mb-4 flex items-center space-x-3">
            </div>
            <!-- Messages will be added here dynamically -->
        </div>

        <!-- Input Section -->
        <div class="bg-gray-900 rounded-lg border border-gray-800 p-6 shadow-xl">
            <!-- Search Style Selection -->
            <div class="mb-6">
                <label class="block text-white font-semibold mb-2 text-lg">
                    Search Style
                </label>
                <select id="model-type"
                    class="bg-black text-white border border-red-600 rounded-lg px-4 py-2.5 w-full focus:ring-2 focus:ring-red-600 focus:border-red-600 hover:border-red-500 cursor-pointer">
                    <option value="tfidf">Keyword Search</option>
                    <option value="embeddings">Semantic Search</option>
                    <option value="agent">Agent Search</option>
                </select>
            </div>
            <!-- Optional Filters -->
            <div id="UseFilters"
                class="flex items-center space-x-3 p-3 bg-black text-white border border-red-600 rounded-lg">
                <input id="useFiltersCheckbox" type="checkbox"
                    class="h-5 w-5 text-red-500 bg-gray-800 border-gray-600 rounded focus:ring-red-500">
                <label for="useFiltersCheckbox" class="text-sm font-medium">Allow agent to use filters <span
                        class="text-xs text-red-300">(results are inconsistent)</span></label>
            </div>

            <div id="filters-container" class="mb-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                <h3 class="text-white font-semibold text-lg col-span-full mb-2">Optional Filters</h3>

                <!-- Prefix Filter -->
                <div>
                    <label class="block text-gray-300 mb-2">Prefix</label>
                    <input type="text"
                        class="prefix-input bg-black text-white border border-red-600 rounded-lg px-4 py-2.5 w-full focus:ring-2 focus:ring-red-600 focus:border-red-600 hover:border-red-500"
                        placeholder="CS, POLS, etc.">
                </div>

                <!-- Class Level Filter -->
                <div>
                    <label class="block text-gray-300 mb-2">Class Level</label>
                    <select id="bucket-filter"
                        class="bg-black text-white border border-red-600 rounded-lg px-4 py-2.5 w-full focus:ring-2 focus:ring-red-600 focus:border-red-600 hover:border-red-500 cursor-pointer">
                        <option value="None">All Levels</option>
                        <option value="1000">1000-1999</option>
                        <option value="2000">2000-2999</option>
                        <option value="3000">3000-2999</option>
                        <option value="4000">4000-4999</option>
                        <option value="5000">5000-5999</option>
                        <option value="6000">6000-6999</option>
                        <option value="7000">7000-7999</option>
                        <option value="8000">8000-8999</option>
                        <option value="9000">9000+</option>
                    </select>
                </div>

                <!-- Credits Filter -->
                <div>
                    <label class="block text-gray-300 mb-2">Credits</label>
                    <input type="number"
                        class="credits-filter bg-black text-white border border-red-600 rounded-lg px-4 py-2.5 w-full focus:ring-2 focus:ring-red-600 focus:border-red-600 hover:border-red-500"
                        placeholder="How many credits...">
                </div>

                <!-- Major Requirement Filter -->
                <div>
                    <label class="block text-gray-300 mb-2">Major Requirement</label>
                    <select id="major-requirement-filter"
                        class="bg-black text-white border border-red-600 rounded-lg px-4 py-2.5 w-full focus:ring-2 focus:ring-red-600 focus:border-red-600 hover:border-red-500 cursor-pointer">
                        <option value="">All Courses</option>
                        <option value="CS">Computer Science Major Requirements</option>
                        <option value="Cyber">Cybersecurity Major Requirements</option>
                        <option value="Data Science">Data Science Major Requirements</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Query Input -->
        <div class="mb-4">
            <label class="block text-white font-semibold mb-4 mt-4 text-lg">
                Make your query here
            </label>
            <textarea
                class="message-input bg-black text-white border border-red-600 rounded-lg px-4 py-3 w-full focus:ring-2 focus:ring-red-600 focus:border-red-600 hover:border-red-500 resize-none"
                placeholder="What sort of topic do you want to learn..." rows="3"></textarea>
        </div>

        <!-- Send Button -->
        <button
            class="send-button w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-lg transition-all duration-300 transform hover:scale-105 hover:shadow-lg hover:shadow-red-600/50">
            Send
        </button>
        </div>
    </main>

    <!-- Flowbite JS -->
    <script src="https://cdn.jsdelivr.net/npm/flowbite@2.5.2/dist/flowbite.min.js"></script>

    <script>
        // Get elements
        const chatMessages = document.getElementById('chat-messages');
        const messageInput = document.querySelector('.message-input');
        const sendButton = document.querySelector('.send-button');

        // Function to add a message to the chat
        function addMessage(content, isUser = false) {
            // Show chat container when first message is added
            if (chatMessages.classList.contains('hidden')) {
                chatMessages.classList.remove('hidden');
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `message-enter ${isUser ? 'flex justify-end' : 'flex justify-start'}`;

            const contentDiv = document.createElement('div');
            contentDiv.className = `max-w-[80%] rounded-lg p-4 ${isUser
                ? 'bg-red-600 text-white'
                : 'bg-gray-800 text-white border border-gray-700'
                }`;

            if (isUser) {
                contentDiv.textContent = content;
            } else {
                contentDiv.innerHTML = content;
            }

            messageDiv.appendChild(contentDiv);
            chatMessages.appendChild(messageDiv);

            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Get filter elements
        const modelInput = document.querySelector('#model-type');
        const prefixInput = document.querySelector('.prefix-input');
        const bucketFilter = document.querySelector('#bucket-filter');
        const creditsFilter = document.querySelector('.credits-filter');
        const majorRequirementFilter = document.querySelector('#major-requirement-filter');
        const checkbox = document.querySelector('#UseFilters input[type="checkbox"]');

        // Hide filters for embedding-based or agent searches
        function updateFiltersVisibility() {
            const filters = document.getElementById('filters-container');
            const checkboxToggle = document.getElementById('UseFilters');
            if (!filters) return;
            const val = modelInput.value;
            if (val === 'embeddings') {
                filters.style.display = 'none';
                checkboxToggle.style.display = 'none';
            } else if (val === 'agent') {
                filters.style.display = 'none';
                checkboxToggle.style.display = 'block';
            } else {
                filters.style.display = 'grid';
                checkboxToggle.style.display = 'none';
            }
        }

        modelInput.addEventListener('change', updateFiltersVisibility);
        // initial state
        updateFiltersVisibility();

        // Function to send message
        async function sendMessage() {
            const message = messageInput.value.trim();

            if (!message) return;

            // Add user message to chat
            addMessage(message, true);

            // Clear input and disable button
            messageInput.value = '';
            sendButton.disabled = true;
            sendButton.textContent = 'Sending...';
            sendButton.classList.add('opacity-75', 'cursor-not-allowed');

            try {
                const modelType = modelInput.value;
                const prefix = prefixInput.value.trim();
                const bucket = bucketFilter.value;
                const credits = creditsFilter.value.trim();
                const majorRequirement = majorRequirementFilter.value.trim();
                // Determine whether filters are active. Send as '1' or '0' so backend
                // doesn't interpret the literal string 'false' as truthy.
                // Determine whether filters toggle is visible to the user. If the
                // `#UseFilters` control is visible, respect the checkbox state.
                // If the control itself is hidden, treat filters as disabled.
                const useFiltersToggle = document.getElementById('UseFilters');
                let useFilters = '0';
                if (useFiltersToggle && window.getComputedStyle(useFiltersToggle).display !== 'none') {
                    useFilters = (checkbox && checkbox.checked) ? '1' : '0';
                } else {
                    // Toggle not visible (or missing) -> filters disabled
                    useFilters = '0';
                }


                // Send request to backend with all parameters
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `message=${encodeURIComponent(message)}&prefix=${encodeURIComponent(prefix)}&bucket=${encodeURIComponent(bucket)}&credits=${encodeURIComponent(credits)}&major_requirement=${encodeURIComponent(majorRequirement)}&modelType=${encodeURIComponent(modelType)}&useFilters=${encodeURIComponent(useFilters)}`
                });

                const data = await response.json();

                // Add bot response to chat
                addMessage(data.response, false);

            } catch (error) {
                console.error('Error:', error);
                addMessage('<p class="text-red-400">Sorry, there was an error processing your request.</p>', false);
            } finally {
                // Re-enable button
                sendButton.disabled = false;
                sendButton.textContent = 'Send';
                sendButton.classList.remove('opacity-75', 'cursor-not-allowed');
                messageInput.focus();
            }
        }

        // Event listeners
        sendButton.addEventListener('click', sendMessage);

        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Focus input on load
        messageInput.focus();
    </script>
</body>

</html>