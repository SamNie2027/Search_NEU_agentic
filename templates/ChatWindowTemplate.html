<!DOCTYPE html>
<html>

<head>
    <title>Course Search Chatbot</title>
    <link rel="stylesheet" href="/static/style.css">
</head>

<body>
    <div id="chat-messages">
        <!-- Messages will be added here dynamically -->
    </div>

    <div class="input-container">
        <div>
            <h3>Search Style:</h3>
            <div class="inputContainer">
                <label> Search Style: </label>
                <select id="model-type">
                    <option value="tfidf">Keyword Search</option>
                    <option value="embeddings">Semantic Search</option>
                    <option value="agent">Agent Search</option>
                </select>
            </div>
            <div class="switch" id="UseFilters">
                <label> Use Filters (results are inconsistant)</label>
                <input type="checkbox">
                <span class="slider"></span>
            </div>
            <div id="filters-container">
            <h3>Optional Filters:</h3>
            <!-- Input area -->
            <div class="inputContainer">
                <label> Prefix: </label>
                <input type="text" class="prefix-input" placeholder="CS, POLS, etc.">
            </div>

            <!-- Input area -->
            <div class="inputContainer">
                <label> Class Level: </label>
                <select id="bucket-filter">
                    <option value=None>All Levels</option>
                    <option value=1000>1000-1999</option>
                    <option value=2000>2000-2999</option>
                    <option value=3000>3000-3999</option>
                    <option value=4000>4000-4999</option>
                    <option value=5000>5000-5999</option>
                    <option value=6000>6000-6999</option>
                    <option value=7000>7000-7999</option>
                    <option value=8000>8000-8999</option>
                    <option value=9000>9000+</option>
                </select>
            </div>

            <!-- Input area -->
            <div class="inputContainer">
                <label> Credits: </label>
                <input type="number" class="credits-filter" placeholder="How many Credits...">
            </div>

            <!-- Input area -->
            <div class="inputContainer">
                <label> Major Requirement: </label>
                <select id="major-requirement-filter">
                    <option value="">All Courses</option>
                    <option value="CS">CS Major Requirements</option>
                </select>
            </div>
            </div>
        </div>
        <h3>Make your query here:</h3>
        <input type="text" class="message-input" placeholder="What sort of topic do you want to learn..."
            style="width: 400px; height:80px">
        <button class="send-button">Send</button>
    </div>
    <script>
        // Get elements
        const chatContainer = document.querySelector('.chat-container'); // or wherever messages should appear
        const messageInput = document.querySelector('.message-input');
        const sendButton = document.querySelector('.send-button');

        // Function to add a message to the chat
        function addMessage(content, isUser = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = isUser ? 'message user-message' : 'message bot-message';

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';

            if (isUser) {
                contentDiv.textContent = content;
            } else {
                contentDiv.innerHTML = content;
            }

            messageDiv.appendChild(contentDiv);

            // Insert before the input container
            const inputContainer = document.querySelector('.input-container');
            inputContainer.parentNode.insertBefore(messageDiv, inputContainer);

            // Scroll to bottom
            window.scrollTo(0, document.body.scrollHeight);
        }

        // Get filter elements
        const modelInput = document.querySelector('#model-type');
        const prefixInput = document.querySelector('.prefix-input');
        const bucketFilter = document.querySelector('#bucket-filter');
        const creditsFilter = document.querySelector('.credits-filter');
        const majorRequirementFilter = document.querySelector('#major-requirement-filter');
        const checkbox = document.querySelector('#UseFilters input[type="checkbox"]');

        // Hide filters for embedding-based or agent searches
        function updateFiltersVisibility() {
            const filters = document.getElementById('filters-container');
            const checkboxToggle = document.getElementById('UseFilters');
            if (!filters) return;
            const val = modelInput.value;
            if (val === 'embeddings') {
                filters.style.display = 'none';
                checkboxToggle.style.display='none';
            }
            else if(val=== 'agent'){
                filters.style.display = 'none';
                checkboxToggle.style.display='block';
            }
            else {
                filters.style.display = 'block';
                checkboxToggle.style.display='none';
            }
        }

        modelInput.addEventListener('change', updateFiltersVisibility);
        // initial state
        updateFiltersVisibility();

        // Function to send message
        async function sendMessage() {
            const message = messageInput.value.trim();
            const dropdown = document.getElementById("myDropdown");

            if (!message) return;

            // Add user message to chat
            addMessage(message, true);

            // Clear input and disable button
            messageInput.value = '';
            sendButton.disabled = true;
            sendButton.textContent = 'Sending...';

            try {
                const modelType = modelInput.value;
                const prefix = prefixInput.value.trim();
                const bucket = bucketFilter.value;
                const credits = creditsFilter.value.trim();
                const majorRequirement = majorRequirementFilter.value.trim();
                const isChecked = checkbox.checked ? 'true' : 'false';


                // Send request to backend with all parameters
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `message=${encodeURIComponent(message)}&prefix=${encodeURIComponent(prefix)}&bucket=${encodeURIComponent(bucket)}&credits=${encodeURIComponent(credits)}&major_requirement=${encodeURIComponent(majorRequirement)}&modelType=${encodeURIComponent(modelType)}&isChecked=${encodeURIComponent(isChecked)}`
                });

                const data = await response.json();

                // Add bot response to chat
                addMessage(data.response, false);

            } catch (error) {
                console.error('Error:', error);
                addMessage('<p>Sorry, there was an error processing your request.</p>', false);
            } finally {
                // Re-enable button
                sendButton.disabled = false;
                sendButton.textContent = 'Send';
                messageInput.focus();
            }
        }

        // Event listeners
        sendButton.addEventListener('click', sendMessage);

        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Focus input on load
        messageInput.focus();
    </script>
</body>

</html>